<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchard Chill Dashboard - Advanced Filtering</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c5f2d; --secondary: #97bc62; --bg: #f4f7f6; --text: #333; --white: #fff; --border: #ddd; --avg-bg: #e8f5e9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; flex-direction: column; gap: 5px; }
        
        .btn-group { display: flex; gap: 5px; margin-bottom: 20px; justify-content: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background-color: #ddd; }
        .btn.active { background-color: var(--primary); color: var(--white); }
        
        select { padding: 8px; border-radius: 5px; border: 1px solid var(--border); }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: var(--primary); color: var(--white); }
        
        tr.avg-row { background-color: var(--avg-bg); font-weight: bold; }
        .progress-bar { height: 8px; background-color: #eee; border-radius: 4px; width: 60px; display: inline-block; margin-right: 5px; }
        .progress-fill { height: 100%; background-color: var(--secondary); border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>District & Ranch Chill Analysis</h1>
        <p>Data Status: January 11, 2026</p>
    </header>

    <div class="btn-group">
        <button class="btn active" id="btn-hours" onclick="setMetric('hours')">Chill Hours</button>
        <button class="btn" id="btn-portions" onclick="setMetric('portions')">Chill Portions</button>
    </div>

    <div class="filter-grid">
        <div class="filter-item">
            <label><strong>Ranch:</strong></label>
            <select id="ranchSelect" onchange="handleRanchChange(this.value)">
                <option value="All">All Ranches</option>
                <option value="Corcoran">Corcoran (Stevenson/Homeland)</option>
                <option value="Kern">Kern (BV/Kern Lake)</option>
            </select>
        </div>
        <div class="filter-item">
            <label><strong>District:</strong></label>
            <select id="districtSelect" onchange="updateUI()">
                <option value="All">All Districts</option>
                <option value="Stevenson">Stevenson</option>
                <option value="Homeland">Homeland</option>
                <option value="Buena Vista">Buena Vista</option>
                <option value="Kern Lake">Kern Lake</option>
            </select>
        </div>
        <div class="filter-item">
            <label><strong>Comparison Year:</strong></label>
            <select id="yearSelect" onchange="updateUI()">
                <option value="2025">Historic 2025</option>
                <option value="2024">Historic 2024</option>
            </select>
        </div>
    </div>

    <div class="card">
        <canvas id="mainChart" height="100"></canvas>
    </div>

    <div class="card">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Location</th>
                    <th>District</th>
                    <th>2026 Current</th>
                    <th id="histHeader">2025 Historic</th>
                    <th>% vs Historic</th>
                    <th>Goal (F. Kerm)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Data sourced from PDF sources 12, 13, and 16
    const orchards = [
        { loc: "STV 28", ranch: "Corcoran", dist: "Stevenson", h26: 569, h25: 607, h24: 542, p26: 39, p25: 41, p24: 33 },
        { loc: "STV 27 SW", ranch: "Corcoran", dist: "Stevenson", h26: 596, h25: 663, h24: 591, p26: 37, p25: 38, p24: 34 },
        { loc: "STV 27 SE", ranch: "Corcoran", dist: "Stevenson", h26: 568, h25: 628, h24: 555, p26: 38, p25: 39, p24: 32 },
        { loc: "STV 27 NE", ranch: "Corcoran", dist: "Stevenson", h26: 574, h25: 621, h24: 552, p26: 39, p25: 41, p24: 33 },
        { loc: "STV 22", ranch: "Corcoran", dist: "Stevenson", h26: 574, h25: 628, h24: 566, p26: 39, p25: 38, p24: 33 },
        { loc: "STV 26D", ranch: "Corcoran", dist: "Stevenson", h26: 555, h25: 583, h24: 537, p26: 38, p25: 38, p24: 31 },
        { loc: "STV 35", ranch: "Corcoran", dist: "Stevenson", h26: 552, h25: 584, h24: 511, p26: 36, p25: 41, p24: 31 },
        { loc: "STV 2", ranch: "Corcoran", dist: "Stevenson", h26: 585, h25: 616, h24: 535, p26: 39, p25: 39, p24: 32 },
        { loc: "STV 3", ranch: "Corcoran", dist: "Stevenson", h26: 590, h25: 631, h24: 533, p26: 38, p25: 38, p24: 31 },
        { loc: "STV 4", ranch: "Corcoran", dist: "Stevenson", h26: 563, h25: 572, h24: 482, p26: 39, p25: 38, p24: 33 },
        { loc: "HL 32 NW", ranch: "Corcoran", dist: "Homeland", h26: 573, h25: 589, h24: 488, p26: 39, p25: 41, p24: 36 },
        { loc: "KL", ranch: "Kern", dist: "Kern Lake", h26: 528, h25: 607, h24: 519, p26: 38, p25: 36, p24: 33 },
        { loc: "BV", ranch: "Kern", dist: "Buena Vista", h26: 596, h25: 614, h24: 546, p26: 39, p25: 38, p24: 31 }
    ];

    let currentMetric = 'hours';
    let chartObj = null;

    function handleRanchChange(ranch) {
        const distSelect = document.getElementById('districtSelect');
        distSelect.value = "All";
        Array.from(distSelect.options).forEach(opt => {
            if (opt.value === "All") opt.hidden = false;
            else if (ranch === "Corcoran") opt.hidden = !["Stevenson", "Homeland"].includes(opt.value);
            else if (ranch === "Kern") opt.hidden = !["Buena Vista", "Kern Lake"].includes(opt.value);
            else opt.hidden = false;
        });
        updateUI();
    }

    function setMetric(m) {
        currentMetric = m;
        document.getElementById('btn-hours').classList.toggle('active', m === 'hours');
        document.getElementById('btn-portions').classList.toggle('active', m === 'portions');
        updateUI();
    }

    function updateUI() {
        const ranch = document.getElementById('ranchSelect').value;
        const dist = document.getElementById('districtSelect').value;
        const year = document.getElementById('yearSelect').value;
        const goalVal = currentMetric === 'hours' ? 800 : 58;

        document.getElementById('histHeader').innerText = year + " Historic";

        const filtered = orchards.filter(o => 
            (ranch === "All" || o.ranch === ranch) && 
            (dist === "All" || o.dist === dist)
        );

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // Group data by district to calculate averages
        const groups = filtered.reduce((acc, obj) => {
            (acc[obj.dist] = acc[obj.dist] || []).push(obj);
            return acc;
        }, {});

        const labels = [], curVals = [], histVals = [];

        Object.keys(groups).forEach(districtName => {
            const districtOrchards = groups[districtName];
            let sumCur = 0, sumHist = 0;

            districtOrchards.forEach(o => {
                const cur = currentMetric === 'hours' ? o.h26 : o.p26;
                const hist = currentMetric === 'hours' ? (year === '2025' ? o.h25 : o.h24) : (year === '2025' ? o.p25 : o.p24);
                
                sumCur += cur;
                sumHist += hist;

                tbody.innerHTML += `<tr>
                    <td>${o.loc}</td>
                    <td>${o.dist}</td>
                    <td>${cur}</td>
                    <td>${hist}</td>
                    <td>${Math.round((cur/hist)*100)}%</td>
                    <td><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(Math.round((cur/goalVal)*100),100)}%"></div></div> ${Math.round((cur/goalVal)*100)}%</td>
                </tr>`;
                
                labels.push(o.loc);
                curVals.push(cur);
                histVals.push(hist);
            });

            // Add District Average Row
            const avgCur = Math.round((sumCur / districtOrchards.length) * 10) / 10;
            const avgHist = Math.round((sumHist / districtOrchards.length) * 10) / 10;
            const avgGoalPct = Math.round((avgCur / goalVal) * 100);

            tbody.innerHTML += `<tr class="avg-row">
                <td>${districtName} AVERAGE</td>
                <td>${districtName}</td>
                <td>${avgCur}</td>
                <td>${avgHist}</td>
                <td>${Math.round((avgCur/avgHist)*100)}%</td>
                <td><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(avgGoalPct, 100)}%"></div></div> ${avgGoalPct}%</td>
            </tr>`;
        });

        // Update Chart
        if (chartObj) chartObj.destroy();
        chartObj = new Chart(document.getElementById('mainChart').getContext('2d'), {
            type: 'bar',
            data: { labels: labels, datasets: [
                { label: '2026 Current', data: curVals, backgroundColor: '#2c5f2d' },
                { label: year + ' Historic', data: histVals, backgroundColor: '#97bc62' }
            ]},
            options: { responsive: true, plugins: { title: { display: true, text: 'Current vs ' + year + ' Comparison' } } }
        });
    }

    updateUI();
</script>
</body>
</html>
