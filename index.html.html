<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchard Chill Dashboard - Multi-Year Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c5f2d; --secondary: #97bc62; --accent: #3498db; --bg: #f4f7f6; --text: #333; --white: #fff; --border: #ddd; --avg-bg: #e8f5e9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; flex-direction: column; gap: 5px; }
        
        .btn-group { display: flex; gap: 5px; margin-bottom: 20 - px; justify-content: center; padding-bottom: 20px;}
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background-color: #ddd; }
        .btn.active { background-color: var(--primary); color: var(--white); }
        
        select { padding: 8px; border-radius: 5px; border: 1px solid var(--border); }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; min-width: 800px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: var(--primary); color: var(--white); position: sticky; top: 0; }
        
        tr.avg-row { background-color: var(--avg-bg); font-weight: bold; border-top: 2px solid var(--primary); }
        .progress-bar { height: 8px; background-color: #eee; border-radius: 4px; width: 50px; display: inline-block; margin-right: 5px; }
        .progress-fill { height: 100%; background-color: var(--secondary); border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>District & Ranch Chill Analysis</h1>
        <p>Comparison of 2026 Current vs Historic Datasets</p>
    </header>

    <div class="btn-group">
        <button class="btn active" id="btn-hours" onclick="setMetric('hours')">Chill Hours</button>
        <button class="btn" id="btn-portions" onclick="setMetric('portions')">Chill Portions</button>
    </div>

    <div class="filter-grid">
        <div class="filter-item">
            <label><strong>Ranch:</strong></label>
            <select id="ranchSelect" onchange="handleRanchChange(this.value)">
                <option value="All">All Ranches</option>
                <option value="Corcoran">Corcoran (Stevenson/Homeland)</option>
                <option value="Kern">Kern (BV/Kern Lake)</option>
            </select>
        </div>
        <div class="filter-item">
            <label><strong>District:</strong></label>
            <select id="districtSelect" onchange="updateUI()">
                <option value="All">All Districts</option>
                <option value="Stevenson">Stevenson</option>
                <option value="Homeland">Homeland</option>
                <option value="Buena Vista">Buena Vista</option>
                <option value="Kern Lake">Kern Lake</option>
            </select>
        </div>
        <div class="filter-item">
            <label><strong>Comparison View:</strong></label>
            <select id="yearSelect" onchange="updateUI()">
                <option value="All">All Years Together</option>
                <option value="2025">vs 2025 Historic Only</option>
                <option value="2024">vs 2024 Historic Only</option>
            </select>
        </div>
    </div>

    <div class="card">
        <canvas id="mainChart" height="100"></canvas>
    </div>

    <div class="card table-responsive">
        <table id="dataTable">
            <thead id="tableHeader"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const orchards = [
        { loc: "STV 28", ranch: "Corcoran", dist: "Stevenson", h26: 569, h25: 607, h24: 542, p26: 39, p25: 41, p24: 33 },
        { loc: "STV 27 SW", ranch: "Corcoran", dist: "Stevenson", h26: 596, h25: 663, h24: 591, p26: 37, p25: 38, p24: 34 },
        { loc: "STV 27 SE", ranch: "Corcoran", dist: "Stevenson", h26: 568, h25: 628, h24: 555, p26: 38, p25: 39, p24: 32 },
        { loc: "STV 27 NE", ranch: "Corcoran", dist: "Stevenson", h26: 574, h25: 621, h24: 552, p26: 39, p25: 41, p24: 33 },
        { loc: "STV 22", ranch: "Corcoran", dist: "Stevenson", h26: 574, h25: 628, h24: 566, p26: 39, p25: 38, p24: 33 },
        { loc: "STV 26D", ranch: "Corcoran", dist: "Stevenson", h26: 555, h25: 583, h24: 537, p26: 38, p25: 38, p24: 31 },
        { loc: "STV 35", ranch: "Corcoran", dist: "Stevenson", h26: 552, h25: 584, h24: 511, p26: 36, p25: 41, p24: 31 },
        { loc: "STV 2", ranch: "Corcoran", dist: "Stevenson", h26: 585, h25: 616, h24: 535, p26: 39, p25: 39, p24: 32 },
        { loc: "STV 3", ranch: "Corcoran", dist: "Stevenson", h26: 590, h25: 631, h24: 533, p26: 38, p25: 38, p24: 31 },
        { loc: "STV 4", ranch: "Corcoran", dist: "Stevenson", h26: 563, h25: 572, h24: 482, p26: 39, p25: 38, p24: 33 },
        { loc: "HL 32 NW", ranch: "Corcoran", dist: "Homeland", h26: 573, h25: 589, h24: 488, p26: 39, p25: 41, p24: 36 },
        { loc: "KL", ranch: "Kern", dist: "Kern Lake", h26: 528, h25: 607, h24: 519, p26: 38, p25: 36, p24: 33 },
        { loc: "BV", ranch: "Kern", dist: "Buena Vista", h26: 596, h25: 614, h24: 546, p26: 39, p25: 38, p24: 31 }
    ];

    let currentMetric = 'hours';
    let chartObj = null;

    function handleRanchChange(ranch) {
        const distSelect = document.getElementById('districtSelect');
        distSelect.value = "All";
        Array.from(distSelect.options).forEach(opt => {
            if (opt.value === "All") opt.hidden = false;
            else if (ranch === "Corcoran") opt.hidden = !["Stevenson", "Homeland"].includes(opt.value);
            else if (ranch === "Kern") opt.hidden = !["Buena Vista", "Kern Lake"].includes(opt.value);
            else opt.hidden = false;
        });
        updateUI();
    }

    function setMetric(m) {
        currentMetric = m;
        document.getElementById('btn-hours').classList.toggle('active', m === 'hours');
        document.getElementById('btn-portions').classList.toggle('active', m === 'portions');
        updateUI();
    }

    function updateUI() {
        const ranch = document.getElementById('ranchSelect').value;
        const dist = document.getElementById('districtSelect').value;
        const view = document.getElementById('yearSelect').value;
        const goalVal = currentMetric === 'hours' ? 800 : 58;

        const filtered = orchards.filter(o => 
            (ranch === "All" || o.ranch === ranch) && 
            (dist === "All" || o.dist === dist)
        );

        // Update Headers
        const header = document.getElementById('tableHeader');
        if (view === "All") {
            header.innerHTML = `<tr><th>Location</th><th>District</th><th>26 Cur</th><th>25 Hist</th><th>24 Hist</th><th>% '25</th><th>% '24</th><th>Goal Progress</th></tr>`;
        } else {
            header.innerHTML = `<tr><th>Location</th><th>District</th><th>26 Cur</th><th>${view} Hist</th><th>% vs ${view}</th><th>Goal Progress</th></tr>`;
        }

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const labels = [], c26 = [], c25 = [], c24 = [];

        const groups = filtered.reduce((acc, obj) => { (acc[obj.dist] = acc[obj.dist] || []).push(obj); return acc; }, {});

        Object.keys(groups).forEach(districtName => {
            const districtOrchards = groups[districtName];
            let s26=0, s25=0, s24=0;

            districtOrchards.forEach(o => {
                const v26 = currentMetric === 'hours' ? o.h26 : o.p26;
                const v25 = currentMetric === 'hours' ? o.h25 : o.p25;
                const v24 = currentMetric === 'hours' ? o.h24 : o.p24;
                s26 += v26; s25 += v25; s24 += v24;

                const goalPct = Math.round((v26/goalVal)*100);
                
                let rowHtml = `<td>${o.loc}</td><td>${o.dist}</td><td>${v26}</td>`;
                if (view === "All") {
                    rowHtml += `<td>${v25}</td><td>${v24}</td><td>${Math.round((v26/v25)*100)}%</td><td>${Math.round((v26/v24)*100)}%</td>`;
                } else if (view === "2025") {
                    rowHtml += `<td>${v25}</td><td>${Math.round((v26/v25)*100)}%</td>`;
                } else {
                    rowHtml += `<td>${v24}</td><td>${Math.round((v26/v24)*100)}%</td>`;
                }
                rowHtml += `<td><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(goalPct,100)}%"></div></div> ${goalPct}%</td>`;
                tbody.innerHTML += `<tr>${rowHtml}</tr>`;

                labels.push(o.loc);
                c26.push(v26); c25.push(v25); c24.push(v24);
            });

            // Average Row
            const len = districtOrchards.length;
            const a26 = Math.round((s26/len)*10)/10, a25 = Math.round((s25/len)*10)/10, a24 = Math.round((s24/len)*10)/10;
            const aGoal = Math.round((a26/goalVal)*100);

            let avgHtml = `<td>${districtName} AVG</td><td>${districtName}</td><td>${a26}</td>`;
            if (view === "All") {
                avgHtml += `<td>${a25}</td><td>${a24}</td><td>${Math.round((a26/a25)*100)}%</td><td>${Math.round((a26/a24)*100)}%</td>`;
            } else if (view === "2025") {
                avgHtml += `<td>${a25}</td><td>${Math.round((a26/a25)*100)}%</td>`;
            } else {
                avgHtml += `<td>${a24}</td><td>${Math.round((a26/a24)*100)}%</td>`;
            }
            avgHtml += `<td><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(aGoal,100)}%"></div></div> ${aGoal}%</td>`;
            tbody.innerHTML += `<tr class="avg-row">${avgHtml}</tr>`;
        });

        // Chart Update
        if (chartObj) chartObj.destroy();
        const datasets = [{ label: '2026 Current', data: c26, backgroundColor: '#2c5f2d' }];
        if (view === "All" || view === "2025") datasets.push({ label: '2025 Historic', data: c25, backgroundColor: '#97bc62' });
        if (view === "All" || view === "2024") datasets.push({ label: '2024 Historic', data: c24, backgroundColor: '#3498db' });

        chartObj = new Chart(document.getElementById('mainChart').getContext('2d'), {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: { responsive: true, plugins: { title: { display: true, text: 'Comparative Data: ' + (currentMetric === 'hours' ? 'Chill Hours' : 'Chill Portions') } } }
        });
    }

    updateUI();
</script>
</body>
</html>
